# Cleanup Safety Rules
## MANDATORY - All Agents Must Follow

**Created**: 2024-12-07
**Status**: ENFORCED
**Priority**: ABSOLUTE - NO EXCEPTIONS

---

## Golden Rules

### Rule 1: NO BLIND DELETIONS
```
FORBIDDEN: rm -rf node_modules
FORBIDDEN: Deleting any file without verification
FORBIDDEN: Removing dependencies without usage check
```

### Rule 2: VERIFY BEFORE REMOVE
Every removal must pass this checklist:
- [ ] File/folder identified for removal
- [ ] Search codebase for imports/references
- [ ] Confirm zero dependencies
- [ ] Document the removal reason
- [ ] Create backup if uncertain

### Rule 3: BUILD MUST PASS
After ANY change:
```bash
pnpm install
pnpm build
# If build fails, REVERT immediately
```

### Rule 4: APP MUST FUNCTION
After cleanup:
- [ ] API starts without errors
- [ ] Web app loads without errors
- [ ] All routes accessible
- [ ] Authentication works
- [ ] Database connections work

---

## Safe Cleanup Categories

### SAFE TO REMOVE (No Verification Needed)
| Item | Reason |
|------|--------|
| `node_modules/` | Regenerated by pnpm install |
| `.next/` | Build cache, regenerated |
| `dist/` | Build output, regenerated |
| `*.log` files | Logs, not code |
| `.cache/` | Cache files |
| `coverage/` | Test coverage reports |
| `*.tmp`, `*.temp` | Temporary files |

### REQUIRES VERIFICATION (Check Before Remove)
| Item | Verification Method |
|------|---------------------|
| Unused dependencies | Run `depcheck`, verify no imports |
| Unused components | Grep for imports across codebase |
| Unused API endpoints | Check route registrations |
| Unused services | Check module imports |
| Test files | Ensure tests still pass |

### NEVER REMOVE (Protected)
| Item | Reason |
|------|--------|
| `package.json` | Core config |
| `tsconfig.json` | TypeScript config |
| `prisma/schema.prisma` | Database schema |
| `.env*` files | Environment config |
| `next.config.js` | Build config |
| `tailwind.config.js` | Styling config |
| Any file with active imports | In use |

---

## Cleanup Process (Step by Step)

### Phase 1: Analysis Only (NO DELETIONS)
```
1. Run disk usage analysis
2. Identify large folders
3. List candidates for removal
4. Document findings
5. STOP - Report back to ATLAS
```

### Phase 2: Safe Cleanup (After Approval)
```
1. Remove only SAFE TO REMOVE items
2. Run pnpm install
3. Run pnpm build
4. Verify build passes
5. Report results
```

### Phase 3: Dependency Cleanup (With Verification)
```
1. Run depcheck to find unused deps
2. For EACH unused dependency:
   a. Grep codebase for package name
   b. Check for dynamic imports
   c. Check for peer dependencies
   d. If truly unused, remove from package.json
   e. Run pnpm install && pnpm build
   f. If build fails, revert
3. Report final list of removed deps
```

### Phase 4: Dead Code Removal (With Approval)
```
1. Identify unused files with static analysis
2. For EACH file:
   a. Search for imports
   b. Search for dynamic requires
   c. Check if exported in index files
   d. Document removal candidate
3. Present list to ATLAS
4. Wait for approval
5. Remove approved files only
6. Run full build
7. Run available tests
```

---

## Verification Commands

### Before Any Cleanup
```bash
# Save current state
git stash
git status

# Verify current build works
pnpm install
pnpm build

# Note: Build must pass BEFORE cleanup
```

### After Each Cleanup Step
```bash
# Rebuild
pnpm install
pnpm build

# If using API
cd apps/api && pnpm build

# If using web
cd apps/web && pnpm build

# Check for TypeScript errors
pnpm typecheck
```

### Rollback If Needed
```bash
# Restore from git
git checkout -- .
git stash pop

# Or restore specific files
git checkout HEAD -- path/to/file
```

---

## Agent Reporting Requirements

Each agent MUST report:

### After Analysis Phase
```markdown
## Analysis Report

### Disk Usage Breakdown
- Total: X.XX GB
- node_modules: X.XX GB
- .next: X.XX GB
- Other: X.XX GB

### Safe Removal Candidates
1. [folder/file] - [size] - [reason safe]

### Requires Verification
1. [item] - [verification needed]

### Estimated Savings
- Safe removal: X.XX GB
- After verification: X.XX GB

### WAITING FOR APPROVAL
```

### After Cleanup Phase
```markdown
## Cleanup Report

### Removed Items
1. [item] - [size] - [verification passed]

### Build Status
- pnpm install: PASS/FAIL
- pnpm build: PASS/FAIL
- TypeScript: PASS/FAIL

### Final Size
- Before: X.XX GB
- After: X.XX GB
- Saved: X.XX GB

### App Functionality
- API starts: YES/NO
- Web loads: YES/NO
- Auth works: YES/NO
```

---

## Emergency Procedures

### If Build Breaks
```bash
# STOP immediately
# Revert last change
git checkout -- .

# Reinstall dependencies
rm -rf node_modules
pnpm install

# Rebuild
pnpm build

# Report to ATLAS
```

### If App Breaks
```bash
# Restore from last known good state
git stash
git checkout HEAD~1

# Or restore specific commit
git checkout [last-good-commit]

# Report to ATLAS
```

---

## Sign-Off Requirements

Before any deletion is executed:
1. Agent reports findings to ATLAS
2. ATLAS reviews removal list
3. ATLAS approves specific items
4. Agent executes approved removals ONLY
5. Agent verifies build passes
6. Agent reports results

**NO AUTONOMOUS DELETIONS OF CODE FILES**

---

## Summary

| Action | Allowed | Requires Approval |
|--------|---------|-------------------|
| Analyze disk usage | YES | NO |
| List removal candidates | YES | NO |
| Remove node_modules | YES | NO |
| Remove .next cache | YES | NO |
| Remove .log files | YES | NO |
| Remove unused dependency | NO | YES |
| Remove unused file | NO | YES |
| Remove any code | NO | YES |
| Modify package.json | NO | YES |

**WHEN IN DOUBT, ASK ATLAS FIRST**
