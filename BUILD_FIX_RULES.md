# Build Fix Rules & Constraints

## Analysis Summary

Based on analysis from 5 agents (PRISM, BRIDGE, VERIFY, FORGE, VAULT), here are the rules to follow when fixing build errors.

---

## CONSTRAINTS (DO NOT CHANGE)

### 1. Module Resolution
- DO NOT change `tsconfig.json` module resolution settings
- DO NOT change path aliases (`@/`, `@operate/`)
- DO NOT modify `baseUrl` or `paths` configuration

### 2. Dependencies
- DO NOT remove any existing dependencies
- DO NOT downgrade package versions
- CAN add new dependencies if needed

### 3. Barrel Exports Structure
- Billing components: MUST use `@/components/billing/index.ts` barrel
- Hooks: DO NOT create barrel export (prevents circular deps)
- Keep relative imports within component folders

### 4. Database Schema
- DO NOT delete existing tables/columns
- DO NOT rename existing fields (breaking change)
- CAN add new optional fields
- CAN add new tables

### 5. API Endpoints
- DO NOT change existing endpoint paths
- DO NOT change request/response shapes
- CAN add new endpoints

---

## BUILD ERRORS TO FIX

### Error 1: API Memory Issue (ForkTsCheckerWebpackPlugin)
**Status**: Build succeeds despite type checker crash
**Root Cause**: Large codebase causing memory overflow in type checker
**Fix**: Increase NODE_OPTIONS memory OR disable parallel type checking
**Priority**: LOW (build completes successfully)

### Error 2: Web Type Mismatch (PaymentMethods)
**Location**: `apps/web/src/app/(dashboard)/settings/billing/page.tsx:190`
**Issue**: `onAdd` expects `Promise<void>` but gets `Promise<PaymentMethod>`
**Fix**: Remove `return response.data` from hook functions
**File to Change**: `apps/web/src/hooks/use-subscription.ts`
**Lines**: 288, 387, 417, 451

---

## FIX SEQUENCE (ORDER MATTERS)

1. **Fix use-subscription.ts** - Remove return statements (5 min)
2. **Build Web** - Verify frontend compiles (2 min)
3. **Build API** - Verify backend compiles (2 min)
4. **Run Migrations** - Create new tables (5 min)
5. **Configure Stripe** - Add webhook secret (2 min)

---

## STRIPE CONFIGURATION

### Required Environment Variables
```bash
STRIPE_SECRET_KEY=sk_live_xxx
STRIPE_PUBLISHABLE_KEY=pk_live_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
```

### Webhook Endpoint
- URL: `https://operate.guru/api/v1/integrations/stripe/webhooks`
- Events: subscription.*, invoice.*

---

## DATABASE MIGRATIONS

### New Models to Create
- UsageRecord (usage tracking)
- SubscriptionTier (tier limits)
- stripe_webhook_logs (webhook idempotency)

### Strategy
- Use `prisma migrate dev` for development
- Use `prisma migrate deploy` for production

---

## VALIDATION CHECKLIST

After fixes:
- [ ] `pnpm build` completes for all packages
- [ ] No TypeScript errors in web
- [ ] API compiles (memory warning OK)
- [ ] Database migrations applied
- [ ] Stripe webhook secret configured
- [ ] Test webhook with Stripe CLI

---

*Generated by ATLAS Project Manager - 2024-12-07*
