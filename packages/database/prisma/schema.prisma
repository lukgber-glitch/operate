generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  OWNER
  ADMIN
  MANAGER
  MEMBER
  VIEWER
}

model Organisation {
  id        String    @id @default(uuid())
  name      String
  slug      String    @unique
  country   String    @default("DE")
  currency  String    @default("EUR")
  timezone  String    @default("Europe/Berlin")
  settings  Json      @default("{}")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  memberships           Membership[]
  auditLogs             AuditLog[]
  organisationCountries OrganisationCountry[]
  taxCredentials        TaxCredential[]
  employees             Employee[]
  payrollPeriods        PayrollPeriod[]
  transactions          Transaction[]
  deductionSuggestions  DeductionSuggestion[]
  taxDeductionSummaries TaxDeductionSummary[]
  fraudAlerts           FraudAlert[]
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String?
  firstName    String
  lastName     String
  avatarUrl    String?
  locale       String    @default("de")
  mfaEnabled   Boolean   @default(false)
  mfaSecret    String?
  backupCodes  String[]  @default([])
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  memberships   Membership[]
  sessions      Session[]
  auditLogs     AuditLog[]
  oauthAccounts OAuthAccount[]
  employees     Employee[]

  // HR Relations
  leaveRequestsReviewed   LeaveRequest[]  @relation("LeaveRequestReviewer")
  timeEntriesApproved     TimeEntry[]     @relation("TimeEntryApprover")
  payrollPeriodsProcessed PayrollPeriod[] @relation("PayrollProcessor")

  // AI & Classification Relations
  classificationsReviewed TransactionClassificationReview[] @relation("ClassificationReviewer")

  // Tax & Deduction Relations
  deductionsConfirmed DeductionSuggestion[] @relation("DeductionConfirmer")
  deductionsRejected  DeductionSuggestion[] @relation("DeductionRejecter")
  deductionsModified  DeductionSuggestion[] @relation("DeductionModifier")

  // Fraud Prevention Relations
  fraudAlertsResolved  FraudAlert[]    @relation("FraudAlertResolver")
  fraudAuditsPerformed FraudAuditLog[] @relation("FraudAuditPerformer")
}

model Membership {
  id         String    @id @default(uuid())
  userId     String
  orgId      String
  role       Role      @default(MEMBER)
  invitedAt  DateTime  @default(now())
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user         User         @relation(fields: [userId], references: [id])
  organisation Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
  @@index([orgId])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([expiresAt])
}

model AuditLog {
  id         String   @id @default(uuid())
  orgId      String
  userId     String?
  action     String
  entityType String
  entityId   String?
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  organisation Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id])

  @@index([orgId, createdAt])
  @@index([entityType, entityId])
}

model OAuthAccount {
  id           String    @id @default(uuid())
  userId       String
  provider     String
  providerId   String
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
}

// ============================================================================
// COUNTRY CONTEXT MODELS
// ============================================================================

model Country {
  id              String   @id @default(uuid())
  code            String   @unique // ISO 3166-1 alpha-2 (DE, AT, CH)
  code3           String   @unique // ISO 3166-1 alpha-3 (DEU, AUT, CHE)
  name            String
  nameNative      String
  currency        String // EUR, CHF
  currencySymbol  String // €, CHF
  locale          String // de-DE, de-AT, de-CH
  timezone        String // Europe/Berlin, etc.
  fiscalYearStart String // MM-DD format
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  regions               Region[]
  taxAuthorities        TaxAuthority[]
  vatRates              VatRate[]
  deductionCategories   DeductionCategory[]
  governmentApis        GovernmentApi[]
  features              CountryFeature[]
  employmentTypes       EmploymentType[]
  organisationCountries OrganisationCountry[]

  @@index([code])
  @@index([isActive])
}

model Region {
  id         String   @id @default(uuid())
  countryId  String
  code       String // BY, NW, etc.
  name       String
  nameNative String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  country Country @relation(fields: [countryId], references: [id], onDelete: Cascade)

  @@unique([countryId, code])
  @@index([countryId])
}

model TaxAuthority {
  id        String   @id @default(uuid())
  countryId String
  code      String // Finanzamt code, etc.
  name      String
  region    String? // State/province/Bundesland
  address   String?
  phone     String?
  email     String?
  website   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  country Country @relation(fields: [countryId], references: [id], onDelete: Cascade)

  @@unique([countryId, code])
  @@index([countryId])
}

model VatRate {
  id        String    @id @default(uuid())
  countryId String
  name      String // Standard, Reduced, Zero, Super-Reduced
  rate      Decimal   @db.Decimal(5, 2)
  validFrom DateTime
  validTo   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  country Country @relation(fields: [countryId], references: [id], onDelete: Cascade)

  @@index([countryId])
  @@index([validFrom, validTo])
}

model DeductionCategory {
  id            String   @id @default(uuid())
  countryId     String
  code          String // Travel, Office, etc.
  name          String
  description   String?
  maxAmount     Decimal? @db.Decimal(10, 2)
  legalBasis    String? // §9 EStG, etc.
  requiresProof Boolean  @default(true)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  country Country @relation(fields: [countryId], references: [id], onDelete: Cascade)

  @@unique([countryId, code])
  @@index([countryId])
  @@index([isActive])
}

model GovernmentApi {
  id         String   @id @default(uuid())
  countryId  String
  name       String // ELSTER, FinanzOnline, VIES
  baseUrl    String
  sandboxUrl String?
  authType   String // certificate, oauth, api_key
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  country Country @relation(fields: [countryId], references: [id], onDelete: Cascade)

  @@unique([countryId, name])
  @@index([countryId])
  @@index([isActive])
}

model CountryFeature {
  id        String   @id @default(uuid())
  countryId String
  feature   String // tax_filing, vat_validation, etc.
  enabled   Boolean  @default(false)
  config    Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  country Country @relation(fields: [countryId], references: [id], onDelete: Cascade)

  @@unique([countryId, feature])
  @@index([countryId])
  @@index([feature])
}

model EmploymentType {
  id          String   @id @default(uuid())
  countryId   String
  code        String // full_time, part_time, contractor, etc.
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  country Country @relation(fields: [countryId], references: [id], onDelete: Cascade)

  @@unique([countryId, code])
  @@index([countryId])
  @@index([isActive])
}

model OrganisationCountry {
  id        String   @id @default(uuid())
  orgId     String
  countryId String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organisation Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  country      Country      @relation(fields: [countryId], references: [id], onDelete: Cascade)

  @@unique([orgId, countryId])
  @@index([orgId])
  @@index([countryId])
}

enum TaxCredentialType {
  TAX_ID
  VAT_ID
  ELSTER_CERTIFICATE
  API_KEY
  OTHER
}

model TaxCredential {
  id             String            @id @default(uuid())
  orgId          String
  countryCode    String
  type           TaxCredentialType
  name           String
  value          String // Encrypted
  expiresAt      DateTime?
  isActive       Boolean           @default(true)
  lastVerifiedAt DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  organisation Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([countryCode])
  @@index([type])
  @@index([isActive])
}

// ============================================================================
// HR MODELS
// ============================================================================

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum EmploymentStatus {
  ACTIVE
  ON_LEAVE
  TERMINATED
  PENDING
}

enum ContractType {
  PERMANENT
  FIXED_TERM
  PART_TIME
  MINIJOB
  MIDIJOB
  FREELANCE
  INTERNSHIP
  APPRENTICESHIP
}

enum SalaryPeriod {
  HOURLY
  MONTHLY
  ANNUAL
}

enum LeaveType {
  ANNUAL
  SICK
  PARENTAL
  UNPAID
  SPECIAL
  TRAINING
}

enum LeaveRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum TimeEntryStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum PayrollStatus {
  OPEN
  PROCESSING
  COMPLETED
  LOCKED
}

enum SocialSecurityType {
  HEALTH
  PENSION
  UNEMPLOYMENT
  ACCIDENT
  CARE
}

enum SSRegistrationStatus {
  PENDING
  SUBMITTED
  CONFIRMED
  REJECTED
  TERMINATED
}

model Employee {
  id             String  @id @default(uuid())
  orgId          String
  userId         String? // Optional link to User account
  employeeNumber String // Internal employee ID

  // Personal Info
  firstName   String
  lastName    String
  email       String
  phone       String?
  dateOfBirth DateTime
  gender      Gender?
  nationality String? // ISO country code

  // Address
  street      String?
  city        String?
  postalCode  String?
  countryCode String // Work country

  // Tax Info
  taxId     String? // Steuer-ID, etc.
  taxClass  String? // German Steuerklasse
  churchTax Boolean @default(false)

  // Banking
  bankName String?
  iban     String?
  bic      String?

  // Employment
  status          EmploymentStatus @default(ACTIVE)
  hireDate        DateTime
  terminationDate DateTime?

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  organisation       Organisation                 @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user               User?                        @relation(fields: [userId], references: [id])
  contracts          EmploymentContract[]
  leaveEntitlements  LeaveEntitlement[]
  leaveRequests      LeaveRequest[]
  timeEntries        TimeEntry[]
  payslips           Payslip[]
  socialSecurityRegs SocialSecurityRegistration[]

  @@unique([orgId, employeeNumber])
  @@unique([email, orgId])
  @@index([orgId])
  @@index([userId])
  @@index([email])
  @@index([status])
}

model EmploymentContract {
  id         String @id @default(uuid())
  employeeId String

  contractType ContractType
  title        String // Job title
  department   String?
  startDate    DateTime
  endDate      DateTime? // Null for permanent
  probationEnd DateTime?

  // Compensation
  salaryAmount   Decimal      @db.Decimal(10, 2)
  salaryCurrency String       @default("EUR")
  salaryPeriod   SalaryPeriod // MONTHLY, HOURLY, ANNUAL

  // Working Hours
  weeklyHours Decimal  @db.Decimal(4, 1)
  workingDays String[] // ["MON", "TUE", ...]

  // Benefits (JSON for flexibility)
  benefits Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([isActive])
}

model LeaveEntitlement {
  id         String @id @default(uuid())
  employeeId String
  year       Int

  leaveType   LeaveType
  totalDays   Decimal   @db.Decimal(4, 1)
  usedDays    Decimal   @default(0) @db.Decimal(4, 1)
  carriedOver Decimal   @default(0) @db.Decimal(4, 1)
  expiresAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, year, leaveType])
  @@index([employeeId])
  @@index([year])
}

model LeaveRequest {
  id         String @id @default(uuid())
  employeeId String

  leaveType LeaveType
  startDate DateTime
  endDate   DateTime
  totalDays Decimal   @db.Decimal(4, 1)
  reason    String?

  status     LeaveRequestStatus @default(PENDING)
  reviewedBy String? // User ID of approver
  reviewedAt DateTime?
  reviewNote String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  reviewer User?    @relation("LeaveRequestReviewer", fields: [reviewedBy], references: [id])

  @@index([employeeId])
  @@index([status])
  @@index([startDate, endDate])
}

model TimeEntry {
  id         String @id @default(uuid())
  employeeId String

  date         DateTime  @db.Date
  startTime    DateTime?
  endTime      DateTime?
  breakMinutes Int       @default(0)

  totalHours    Decimal @db.Decimal(4, 2)
  overtimeHours Decimal @default(0) @db.Decimal(4, 2)

  projectCode String?
  description String?

  status     TimeEntryStatus @default(DRAFT)
  approvedBy String?
  approvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  approver User?    @relation("TimeEntryApprover", fields: [approvedBy], references: [id])

  @@index([employeeId, date])
  @@index([status])
}

model PayrollPeriod {
  id    String @id @default(uuid())
  orgId String

  year  Int
  month Int

  status      PayrollStatus @default(OPEN)
  processedAt DateTime?
  processedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organisation Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  processor    User?        @relation("PayrollProcessor", fields: [processedBy], references: [id])
  payslips     Payslip[]

  @@unique([orgId, year, month])
  @@index([orgId])
  @@index([status])
}

model Payslip {
  id              String @id @default(uuid())
  employeeId      String
  payrollPeriodId String

  grossSalary Decimal @db.Decimal(10, 2)
  netSalary   Decimal @db.Decimal(10, 2)

  // Deductions (stored as JSON for flexibility)
  deductions Json // { tax, socialSecurity, healthInsurance, etc. }
  additions  Json? // { bonus, overtime, allowances, etc. }

  paidAt     DateTime?
  paymentRef String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employee      Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  payrollPeriod PayrollPeriod @relation(fields: [payrollPeriodId], references: [id], onDelete: Cascade)

  @@unique([employeeId, payrollPeriodId])
  @@index([employeeId])
  @@index([payrollPeriodId])
}

model SocialSecurityRegistration {
  id         String @id @default(uuid())
  employeeId String

  countryCode    String
  registrationId String // SV-Nummer, etc.
  provider       String // Insurance provider name
  type           SocialSecurityType

  startDate DateTime
  endDate   DateTime?

  status      SSRegistrationStatus @default(PENDING)
  submittedAt DateTime?
  confirmedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([countryCode])
  @@index([status])
}

model HrAuditLog {
  id         String  @id @default(uuid())
  orgId      String
  employeeId String?
  userId     String // Who performed the action

  action     String // CREATE, UPDATE, DELETE, APPROVE, etc.
  entityType String // Employee, Contract, LeaveRequest, etc.
  entityId   String

  oldValues Json?
  newValues Json?

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([orgId])
  @@index([employeeId])
  @@index([userId])
  @@index([createdAt])
  @@index([entityType, entityId])
}

// ============================================================================
// AI & CLASSIFICATION MODELS
// ============================================================================

enum ClassificationReviewStatus {
  PENDING
  APPROVED
  REJECTED
  RECLASSIFIED
}

model TransactionClassificationReview {
  id                     String  @id @default(uuid())
  orgId                  String
  transactionId          String // Reference to transaction (could be external ID)
  transactionDescription String
  amount                 Decimal @db.Decimal(10, 2)
  currency               String

  // AI Classification Results
  aiCategory                 String
  aiConfidence               Decimal  @db.Decimal(3, 2)
  aiReasoning                String
  taxRelevant                Boolean
  suggestedDeductionCategory String?
  flags                      String[] @default([])

  // Review Data
  status            ClassificationReviewStatus @default(PENDING)
  priority          Int                        @default(3) // 1-5, higher = more urgent
  correctedCategory String?
  reviewedBy        String? // User ID
  reviewedAt        DateTime?
  reviewNote        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reviewer User? @relation("ClassificationReviewer", fields: [reviewedBy], references: [id])

  @@index([orgId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([orgId, status, priority])
}

// ============================================================================
// TAX & DEDUCTION MODELS
// ============================================================================

enum DeductionSuggestionStatus {
  SUGGESTED
  CONFIRMED
  REJECTED
  MODIFIED
}

model Transaction {
  id    String @id @default(uuid())
  orgId String

  // Transaction details
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("EUR")
  description String
  date        DateTime @db.Date

  // Classification (from OP-040)
  category           String?
  categoryConfidence Decimal? @db.Decimal(3, 2)

  // Metadata
  metadata Json? // Receipt info, business purpose, etc.

  // Status
  isReconciled Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organisation         Organisation          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deductionSuggestions DeductionSuggestion[]

  @@index([orgId])
  @@index([date])
  @@index([category])
}

model DeductionSuggestion {
  id            String @id @default(uuid())
  transactionId String
  orgId         String

  // Matched rule
  ruleId       String
  categoryCode String
  categoryName String

  // Amounts
  originalAmount       Decimal @db.Decimal(10, 2)
  deductibleAmount     Decimal @db.Decimal(10, 2)
  deductiblePercentage Int
  currency             String  @default("EUR")

  // Legal info
  legalReference   String
  legalDescription String

  // Status
  status DeductionSuggestionStatus @default(SUGGESTED)

  // Requirements
  requirements Json // RequirementStatus as JSON

  // AI confidence
  confidence Decimal @db.Decimal(3, 2)
  reasoning  String

  // Audit trail
  createdAt       DateTime  @default(now())
  confirmedAt     DateTime?
  confirmedBy     String?
  rejectedAt      DateTime?
  rejectedBy      String?
  rejectionReason String?
  modifiedAt      DateTime?
  modifiedBy      String?

  transaction  Transaction  @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  organisation Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  confirmer    User?        @relation("DeductionConfirmer", fields: [confirmedBy], references: [id])
  rejecter     User?        @relation("DeductionRejecter", fields: [rejectedBy], references: [id])
  modifier     User?        @relation("DeductionModifier", fields: [modifiedBy], references: [id])

  @@index([transactionId])
  @@index([orgId])
  @@index([status])
  @@index([categoryCode])
  @@index([createdAt])
}

model TaxDeductionSummary {
  id    String @id @default(uuid())
  orgId String

  year        Int
  countryCode String
  currency    String @default("EUR")

  // Totals
  totalOriginalAmount   Decimal @db.Decimal(12, 2)
  totalDeductibleAmount Decimal @db.Decimal(12, 2)

  // Counts
  suggestedCount Int @default(0)
  confirmedCount Int @default(0)
  rejectedCount  Int @default(0)

  // Category breakdown (JSON)
  categories Json

  // Metadata
  lastCalculatedAt DateTime @default(now())

  organisation Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, year, countryCode])
  @@index([orgId])
  @@index([year])
  @@index([countryCode])
}

// ============================================================================
// FRAUD PREVENTION MODELS
// ============================================================================

enum FraudAlertSeverity {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
  WARNING
}

enum FraudAlertStatus {
  ACTIVE
  REVIEWED
  DISMISSED
  RESOLVED
}

model FraudAlert {
  id            String  @id @default(uuid())
  orgId         String
  transactionId String?

  // Alert details
  type     String
  severity FraudAlertSeverity @default(MEDIUM)
  status   FraudAlertStatus   @default(ACTIVE)

  // Information
  description String
  details     Json?
  riskScore   Decimal @db.Decimal(5, 2)

  // Resolution
  resolvedAt DateTime?
  resolvedBy String?
  resolution String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organisation Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  resolver     User?        @relation("FraudAlertResolver", fields: [resolvedBy], references: [id])

  @@index([orgId])
  @@index([transactionId])
  @@index([status])
  @@index([severity])
  @@index([createdAt])
}

model FraudAuditLog {
  id            String  @id @default(uuid())
  orgId         String
  alertId       String?
  transactionId String?

  // Audit details
  action      String
  performedBy String?
  details     Json?

  createdAt DateTime @default(now())

  performer User? @relation("FraudAuditPerformer", fields: [performedBy], references: [id])

  @@index([orgId])
  @@index([alertId])
  @@index([transactionId])
  @@index([createdAt])
}

// ============================================================================
// FINANCE MODELS
// ============================================================================

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
  VOID
}

enum InvoiceType {
  STANDARD
  CREDIT_NOTE
  PROFORMA
  RECURRING
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
  REIMBURSED
}

enum ExpenseCategory {
  TRAVEL
  OFFICE
  SOFTWARE
  EQUIPMENT
  MEALS
  ENTERTAINMENT
  UTILITIES
  RENT
  INSURANCE
  PROFESSIONAL_SERVICES
  OTHER
}

model Invoice {
  id     String        @id @default(uuid())
  orgId  String
  number String // INV-2024-001
  type   InvoiceType   @default(STANDARD)
  status InvoiceStatus @default(DRAFT)

  // Customer
  customerId      String?
  customerName    String
  customerEmail   String?
  customerAddress String?
  customerVatId   String?

  // Dates
  issueDate DateTime  @default(now())
  dueDate   DateTime
  paidDate  DateTime?

  // Amounts
  subtotal    Decimal @db.Decimal(12, 2)
  taxAmount   Decimal @db.Decimal(12, 2)
  totalAmount Decimal @db.Decimal(12, 2)
  currency    String  @default("EUR")

  // VAT
  vatRate       Decimal? @db.Decimal(5, 2)
  reverseCharge Boolean  @default(false)

  // Payment
  paymentTerms  String?
  paymentMethod String?
  bankReference String?

  // Notes
  notes         String?
  internalNotes String?

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items InvoiceItem[]

  @@unique([orgId, number])
  @@index([orgId])
  @@index([status])
  @@index([issueDate])
  @@index([dueDate])
  @@index([customerId])
}

model InvoiceItem {
  id        String @id @default(uuid())
  invoiceId String

  description String
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(12, 2)
  amount      Decimal @db.Decimal(12, 2)

  taxRate   Decimal? @db.Decimal(5, 2)
  taxAmount Decimal? @db.Decimal(12, 2)

  // Optional categorization
  productCode String?
  unit        String?

  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Expense {
  id    String @id @default(uuid())
  orgId String

  // Core details
  description String
  amount      Decimal  @db.Decimal(12, 2)
  currency    String   @default("EUR")
  date        DateTime @db.Date

  // Categorization
  category    ExpenseCategory @default(OTHER)
  subcategory String?

  // Vendor
  vendorName  String?
  vendorVatId String?

  // Receipt
  receiptUrl    String?
  receiptNumber String?

  // Status & Approval
  status          ExpenseStatus @default(PENDING)
  submittedBy     String?
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?

  // Tax
  vatAmount    Decimal? @db.Decimal(12, 2)
  vatRate      Decimal? @db.Decimal(5, 2)
  isDeductible Boolean  @default(true)

  // Payment
  paymentMethod String?
  reimbursedAt  DateTime?

  // Notes
  notes String?

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@index([date])
  @@index([category])
  @@index([status])
  @@index([submittedBy])
}

model BankAccount {
  id    String @id @default(uuid())
  orgId String

  // Account details
  name          String
  accountNumber String?
  iban          String?
  bic           String?
  bankName      String?

  // Type
  accountType String @default("checking") // checking, savings, credit
  currency    String @default("EUR")

  // Balance (synced from bank)
  currentBalance   Decimal?  @db.Decimal(12, 2)
  availableBalance Decimal?  @db.Decimal(12, 2)
  lastSyncedAt     DateTime?

  // Integration
  provider    String? // plaid, finapi, etc.
  externalId  String?
  accessToken String? // encrypted

  // Status
  isActive  Boolean @default(true)
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions BankTransaction[]

  @@unique([orgId, iban])
  @@index([orgId])
  @@index([isActive])
}

model BankTransaction {
  id            String @id @default(uuid())
  bankAccountId String

  // Transaction details
  externalId  String?
  date        DateTime @db.Date
  description String
  amount      Decimal  @db.Decimal(12, 2)
  currency    String   @default("EUR")

  // Direction
  type String // credit, debit

  // Counterparty
  counterpartyName String?
  counterpartyIban String?

  // Reference
  reference   String?
  bookingText String?

  // Categorization (manual or AI)
  category     String?
  isReconciled Boolean @default(false)

  // Link to internal transaction
  transactionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bankAccount BankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  @@index([bankAccountId])
  @@index([date])
  @@index([isReconciled])
  @@index([externalId])
}

// ============================================================================
// DOCUMENT MANAGEMENT MODELS
// ============================================================================

enum DocumentType {
  CONTRACT
  INVOICE
  RECEIPT
  REPORT
  POLICY
  FORM
  CERTIFICATE
  OTHER
}

enum DocumentStatus {
  DRAFT
  ACTIVE
  ARCHIVED
  DELETED
}

model Document {
  id    String @id @default(uuid())
  orgId String

  // Core fields
  name        String
  description String?
  type        DocumentType   @default(OTHER)
  status      DocumentStatus @default(ACTIVE)

  // File info
  fileName String
  fileSize Int
  mimeType String
  fileUrl  String

  // Organization
  folderId String?
  tags     String[] @default([])

  // Metadata
  uploadedBy String
  metadata   Json?

  // Versioning
  version  Int     @default(1)
  parentId String? // For version history

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  folder DocumentFolder? @relation(fields: [folderId], references: [id])

  @@index([orgId])
  @@index([type])
  @@index([status])
  @@index([folderId])
  @@index([uploadedBy])
}

model DocumentFolder {
  id    String @id @default(uuid())
  orgId String

  name        String
  description String?
  parentId    String?
  path        String // /root/subfolder/child

  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parent    DocumentFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id])
  children  DocumentFolder[] @relation("FolderHierarchy")
  documents Document[]

  @@unique([orgId, path])
  @@index([orgId])
  @@index([parentId])
}

// ============================================================================
// COMPLIANCE EXPORT MODELS
// ============================================================================

model GobdExport {
  id           String    @id @default(uuid())
  orgId        String
  status       String    @default("pending")
  year         Int
  format       String    @default("xml")
  filePath     String?
  fileSize     Int?
  checksum     String?
  startDate    DateTime?
  endDate      DateTime?
  filename     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  completedAt  DateTime?
  errorMessage String?

  @@index([orgId])
}

model SaftExport {
  id           String    @id @default(uuid())
  orgId        String
  status       String    @default("pending")
  year         Int
  country      String
  format       String    @default("xml")
  filePath     String?
  fileSize     Int?
  checksum     String?
  startDate    DateTime?
  endDate      DateTime?
  filename     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  completedAt  DateTime?
  errorMessage String?

  @@index([orgId])
}

// ============================================================================
// ELSTER INTEGRATION MODELS
// ============================================================================

model ElsterAuditLog {
  id              String    @id @default(uuid())
  orgId           String
  userId          String?
  submissionType  String // VAT_RETURN, INCOME_TAX, EMPLOYEE_TAX, etc.
  transferTicket  String
  status          String // ACCEPTED, REJECTED, PENDING, etc.
  submittedBy     String // User ID who initiated submission
  submittedAt     DateTime  @default(now())
  respondedAt     DateTime?
  requestPayload  Json // Sanitized request data
  responsePayload Json? // Sanitized response data
  ipAddress       String?
  userAgent       String?
  errors          String[]  @default([])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([orgId])
  @@index([transferTicket])
  @@index([submissionType])
  @@index([status])
  @@index([submittedAt])
  @@index([orgId, submittedAt])
}

// ============================================================================
// AUTOMATION & NOTIFICATION MODELS
// ============================================================================

enum AutomationMode {
  FULL_AUTO // Process without human review
  SEMI_AUTO // AI suggests, human approves
  MANUAL // Human does everything
}

model AutomationSettings {
  id                  String         @id @default(uuid())
  orgId               String
  feature             String // classification, expense, deduction, invoice
  mode                AutomationMode @default(SEMI_AUTO)
  confidenceThreshold Decimal?       @db.Decimal(3, 2) // Auto-approve above this (e.g., 0.95)
  amountThreshold     Decimal?       @db.Decimal(12, 2) // Auto-approve below this amount
  enabled             Boolean        @default(true)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  @@unique([orgId, feature])
  @@index([orgId])
}

model AutomationAuditLog {
  id            String   @id @default(uuid())
  orgId         String
  feature       String
  entityType    String // transaction, expense, deduction
  entityId      String
  action        String // AUTO_APPROVED, AUTO_CLASSIFIED, AUTO_REJECTED
  previousValue String?
  newValue      String?
  confidence    Decimal? @db.Decimal(3, 2)
  ruleApplied   String?
  executedAt    DateTime @default(now())

  @@index([orgId, feature])
  @@index([entityType, entityId])
  @@index([executedAt])
}

model Notification {
  id        String    @id @default(uuid())
  userId    String
  orgId     String
  type      String // approval_needed, fraud_alert, deadline, auto_action
  title     String
  message   String
  data      Json?
  status    String    @default("UNREAD") // UNREAD, READ, ARCHIVED
  priority  Int       @default(3) // 1-5, 5 being highest
  readAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId, status])
  @@index([orgId, type])
  @@index([createdAt])
}
