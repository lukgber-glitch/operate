# Phase 7: Parallel Swarm - Analysis + Remediation

## Objective

Execute a parallel swarm architecture where:
- **5 Analysis Agents** complete deep-dive audits (prompts 002-006)
- **Fix Agents** start remediation on known P0 issues immediately
- **1 Project Manager (ATLAS)** monitors analysis, updates fix tasklist dynamically

This maximizes throughput by running discovery and fixing in parallel.

## Context

@audits/COMPREHENSIVE_AUDIT_REPORT.md - Initial audit findings (82/100 health score)
@audits/REMEDIATION_PLAN.md - Known issues to fix
@prompts/002-code-quality-scanner.md
@prompts/003-security-audit.md
@prompts/004-api-completeness-check.md
@prompts/005-database-schema-validator.md
@prompts/006-ux-chat-enhancement-research.md

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    ATLAS (Project Manager)                       │
│  - Monitors all agent outputs                                    │
│  - Updates TASKLIST.md when new issues found                     │
│  - Coordinates fix agent priorities                              │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│ ANALYSIS SWARM │   │  FIX SWARM    │   │   OUTPUTS     │
│ (5 agents)     │   │  (3 agents)   │   │               │
│                │   │               │   │ TASKLIST.md   │
│ 002-code-qual  │   │ FIX-P0-01     │   │ (live updated)│
│ 003-security   │   │ FIX-P0-02     │   │               │
│ 004-api        │   │ FIX-P0-03     │   │ findings/*.md │
│ 005-database   │   │               │   │ (per agent)   │
│ 006-ux-chat    │   │               │   │               │
└───────────────┘   └───────────────┘   └───────────────┘
```

## Execution Plan

### Step 1: Initialize Coordination Files

Create `./audits/TASKLIST.md` - Live task tracker for fix agents:

```markdown
# Fix Agent Tasklist
Last Updated: [timestamp]
Updated By: ATLAS

## P0 - Critical (In Progress)
- [ ] C-001: Generate npm lockfiles - FLUX
- [ ] C-002: Receipt scanning - BRIDGE
- [ ] C-003: JWT secrets hardcoding - SENTINEL

## P1 - High (Queue)
- [ ] H-001: Email→Bill automation - BRIDGE
- [ ] H-002: Replace `any` types - FORGE
- [ ] H-003: Webhook signature validation - SENTINEL
- [ ] H-004: Bulk operations API - FORGE
- [ ] H-005: Chat persistence - PRISM

## Discovered (Added by Analysis)
[ATLAS adds new issues here as analysis agents report]
```

### Step 2: Launch Analysis Swarm (5 agents in parallel)

**CRITICAL: Launch ALL 5 in a SINGLE message with multiple Task tool calls**

Use Task tool with subagent_type="general-purpose" for each:

1. **Agent: Code Quality Scanner**
   - Read: `prompts/002-code-quality-scanner.md`
   - Execute the prompt
   - Output to: `audits/findings/code-quality.md`

2. **Agent: Security Auditor**
   - Read: `prompts/003-security-audit.md`
   - Execute the prompt
   - Output to: `audits/findings/security.md`

3. **Agent: API Completeness Checker**
   - Read: `prompts/004-api-completeness-check.md`
   - Execute the prompt
   - Output to: `audits/findings/api-completeness.md`

4. **Agent: Database Schema Validator**
   - Read: `prompts/005-database-schema-validator.md`
   - Execute the prompt
   - Output to: `audits/findings/database-schema.md`

5. **Agent: UX/Chat Researcher**
   - Read: `prompts/006-ux-chat-enhancement-research.md`
   - Execute the prompt
   - Output to: `audits/findings/ux-chat.md`

### Step 3: Launch Fix Swarm (3 agents in parallel)

**Launch simultaneously with Analysis Swarm**

1. **Agent: FIX-P0-01 (FLUX - DevOps)**
   Task: Generate npm lockfiles and run security audit
   ```
   cd apps/api && npm install --package-lock-only
   cd apps/web && npm install --package-lock-only
   npm audit --json > audits/npm-audit-results.json
   git add apps/*/package-lock.json
   git commit -m "chore: add package-lock.json for security auditing"
   ```
   Output: `audits/fixes/p0-01-npm-lockfiles.md`

2. **Agent: FIX-P0-02 (SENTINEL - Security)**
   Task: Remove hardcoded JWT secrets
   - Find all fallback secrets in config
   - Replace with required env vars (throw if missing)
   - Update .env.example with required vars
   Output: `audits/fixes/p0-02-jwt-secrets.md`

3. **Agent: FIX-P0-03 (BRIDGE - Integrations)**
   Task: Start receipt scanning implementation
   - Wire MindeeService into ReceiptsModule
   - Begin implementing ReceiptsService
   Output: `audits/fixes/p0-03-receipt-scanning.md`

### Step 4: ATLAS Monitoring Loop

After launching all 8 agents, ATLAS enters monitoring mode:

```
WHILE agents_running:
  1. Check AgentOutputTool for completed agents
  2. FOR each completed analysis agent:
     - Read their findings output
     - Extract NEW issues not in TASKLIST.md
     - Add to TASKLIST.md under "Discovered" section
     - Prioritize (P0/P1/P2/P3)
  3. FOR each completed fix agent:
     - Verify fix was successful
     - Mark task complete in TASKLIST.md
     - If fix failed, add blocker note
  4. IF high-priority issue discovered:
     - Launch new fix agent for it
  5. Sleep 30 seconds, repeat
```

### Step 5: Consolidation

When all agents complete:

1. Merge all findings into `audits/COMPREHENSIVE_AUDIT_REPORT_v2.md`
2. Update `audits/REMEDIATION_PLAN.md` with discovered issues
3. Generate `audits/SWARM_SUMMARY.md`:
   - Issues discovered by each analysis agent
   - Fixes completed by each fix agent
   - New issues added to backlog
   - Overall health score improvement

## Success Criteria

- [ ] All 5 analysis agents completed and reported findings
- [ ] All 3 P0 fix agents completed their tasks
- [ ] TASKLIST.md updated with any newly discovered issues
- [ ] npm lockfiles generated and committed
- [ ] JWT hardcoded secrets removed
- [ ] Receipt scanning implementation started
- [ ] Health score improved from 82% toward 90%+

## Output Files

```
audits/
├── TASKLIST.md                    # Live task tracker
├── findings/
│   ├── code-quality.md            # From 002 agent
│   ├── security.md                # From 003 agent
│   ├── api-completeness.md        # From 004 agent
│   ├── database-schema.md         # From 005 agent
│   └── ux-chat.md                 # From 006 agent
├── fixes/
│   ├── p0-01-npm-lockfiles.md     # Fix agent 1 report
│   ├── p0-02-jwt-secrets.md       # Fix agent 2 report
│   └── p0-03-receipt-scanning.md  # Fix agent 3 report
├── COMPREHENSIVE_AUDIT_REPORT_v2.md  # Merged findings
└── SWARM_SUMMARY.md               # Overall swarm results
```

## Verification

After all agents complete:

1. Verify findings/ has 5 files (one per analysis agent)
2. Verify fixes/ has 3 files (one per fix agent)
3. Verify TASKLIST.md has "Discovered" section populated
4. Run `npm audit` - should work now (lockfiles exist)
5. Check config files - no hardcoded secrets
6. Verify ReceiptsModule imports MindeeModule
