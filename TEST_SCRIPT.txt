const puppeteer = require('puppeteer');
const fs = require('fs');
const path = require('path');

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

(async () => {
  const browser = await puppeteer.launch({
    headless: false,
    defaultViewport: { width: 1920, height: 1080 },
    args: ['--start-maximized', '--disable-blink-features=AutomationControlled']
  });

  const page = await browser.newPage();
  const results = [];
  const jsErrors = [];
  const apiErrors = [];

  page.on('pageerror', error => {
    jsErrors.push({
      message: error.message,
      stack: error.stack
    });
  });

  page.on('console', msg => {
    if (msg.type() === 'error') {
      jsErrors.push({
        message: msg.text(),
        location: msg.location()
      });
    }
  });

  page.on('response', response => {
    if (response.status() >= 400) {
      apiErrors.push({
        url: response.url(),
        status: response.status(),
        statusText: response.statusText()
      });
    }
  });

  try {
    console.log('Starting Batch 14+15 test...');

    console.log('Navigating to login page...');
    await page.goto('https://operate.guru/login', { 
      waitUntil: 'domcontentloaded',
      timeout: 90000 
    });

    await sleep(3000);
    await page.screenshot({ path: path.join(__dirname, 'test-screenshots', 'batch14-15-01-login.png') });

    console.log('Looking for login form...');
    await page.waitForSelector('input[type="email"], input[name="email"]', { timeout: 15000 });
    
    await page.type('input[type="email"], input[name="email"]', 'luk.gber@gmail.com', { delay: 50 });
    await sleep(500);
    await page.type('input[type="password"], input[name="password"]', 'Schlagzeug1@', { delay: 50 });
    
    await page.screenshot({ path: path.join(__dirname, 'test-screenshots', 'batch14-15-02-credentials-entered.png') });

    console.log('Clicking login button...');
    await page.click('button[type="submit"]');
    
    await sleep(5000);
    await page.screenshot({ path: path.join(__dirname, 'test-screenshots', 'batch14-15-03-after-login.png') });
    console.log('Login complete!');

    const testPages = [
      { url: '/intelligence', name: 'Intelligence' },
      { url: '/intelligence/email', name: 'Intelligence Email' },
      { url: '/autopilot', name: 'Autopilot' },
      { url: '/autopilot/actions', name: 'Autopilot Actions' },
      { url: '/autopilot/settings', name: 'Autopilot Settings' },
      { url: '/admin', name: 'Admin' },
      { url: '/developer', name: 'Developer' },
      { url: '/developer/api-keys', name: 'API Keys' },
      { url: '/developer/webhooks', name: 'Webhooks' },
      { url: '/api-docs', name: 'API Docs' },
      { url: '/help', name: 'Help' },
      { url: '/feedback', name: 'Feedback' },
      { url: '/health-score', name: 'Health Score' }
    ];

    for (let i = 0; i < testPages.length; i++) {
      const testPage = testPages[i];
      const pageNum = String(i + 4).padStart(2, '0');
      
      console.log(`\nTesting ${testPage.name} (${testPage.url})...`);
      
      const beforeErrorCount = jsErrors.length;
      const beforeApiErrorCount = apiErrors.length;
      
      try {
        await page.goto(`https://operate.guru${testPage.url}`, { 
          waitUntil: 'domcontentloaded',
          timeout: 45000 
        });

        await sleep(3000);

        const urlPath = testPage.url.replace(/\//g, '-').substring(1);
        const screenshotPath = path.join(__dirname, 'test-screenshots', `batch14-15-${pageNum}-${urlPath}.png`);
        await page.screenshot({ path: screenshotPath });

        const bodyText = await page.evaluate(() => document.body.innerText);
        const hasError = bodyText.includes('404') || bodyText.includes('Not Found') || bodyText.toLowerCase().includes('page not found');

        const newJsErrors = jsErrors.slice(beforeErrorCount);
        const newApiErrors = apiErrors.slice(beforeApiErrorCount);

        const criticalApiErrors = newApiErrors.filter(e => e.status >= 500);
        const status = (!hasError && newJsErrors.length === 0 && criticalApiErrors.length === 0) ? 'PASS' : 'FAIL';

        results.push({
          page: testPage.url,
          name: testPage.name,
          status: status,
          jsErrors: newJsErrors,
          apiErrors: newApiErrors,
          screenshot: screenshotPath
        });

        console.log(`${testPage.name}: ${status}`);
        if (newJsErrors.length > 0) {
          console.log(`  JS Errors: ${newJsErrors.length}`);
        }
        if (newApiErrors.length > 0) {
          console.log(`  API Errors: ${newApiErrors.length}`);
        }

      } catch (error) {
        results.push({
          page: testPage.url,
          name: testPage.name,
          status: 'FAIL',
          error: error.message,
          jsErrors: [],
          apiErrors: []
        });
        console.log(`${testPage.name}: FAIL - ${error.message}`);
      }
    }

  } catch (error) {
    console.error('Test failed:', error);
    results.push({
      page: 'LOGIN',
      status: 'FAIL',
      error: error.message
    });
  }

  const report = {
    timestamp: new Date().toISOString(),
    batch: 'BATCH_14_15_INTELLIGENCE_ADMIN',
    results: results,
    summary: {
      total: results.length,
      passed: results.filter(r => r.status === 'PASS').length,
      failed: results.filter(r => r.status === 'FAIL').length
    },
    allJsErrors: jsErrors,
    allApiErrors: apiErrors
  };

  fs.writeFileSync(
    path.join(__dirname, 'BATCH_12_13_TEST_RESULTS.json'),
    JSON.stringify(report, null, 2)
  );

  console.log('\n=== TEST COMPLETE ===');
  console.log(`Total: ${report.summary.total}`);
  console.log(`Passed: ${report.summary.passed}`);
  console.log(`Failed: ${report.summary.failed}`);

  await browser.close();
})();
