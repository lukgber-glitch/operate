# PWA Configuration for Operate

This document describes the Progressive Web App (PWA) configuration for the Operate web application.

## Overview

The Operate app is configured as a PWA to provide:
- Offline functionality with cached data
- Installable web app experience
- Fast loading with service worker caching
- Background sync capabilities
- Native-like experience on mobile devices

## Configuration Files

### 1. `next.config.js`
- Configures `@ducanh2912/next-pwa` plugin
- Defines caching strategies for different resource types
- Excludes auth endpoints from caching
- Automatically disabled in development and Capacitor native builds

### 2. `public/manifest.json`
- App metadata (name, description, theme colors)
- Icon definitions (SVG and PNG variants)
- Display mode: standalone
- App shortcuts for quick access
- Language and orientation settings

### 3. `public/sw.js` (auto-generated)
- Service worker generated by next-pwa
- Implements Workbox caching strategies
- Handles offline fallback

### 4. `src/app/offline/page.tsx`
- Offline fallback page
- Shows cached data availability
- Auto-reloads when connection restored
- Provides retry functionality

## Caching Strategies

### Cache First (Long-lived assets)
- Google Fonts: 1 year cache
- Static assets that rarely change

### Stale While Revalidate (Dynamic assets)
- Images: 1 day cache, 64 entries max
- Font files: 1 week cache, 4 entries max
- JavaScript files: 1 day cache, 32 entries max
- CSS files: 1 day cache, 32 entries max

### Network First (API & Dynamic content)
- API routes (non-auth): 1 hour cache, 128 entries max
- External APIs: 1 hour cache, 64 entries max
- All other requests: 1 day cache, 32 entries max

### Never Cached
- `/api/auth/*` - Authentication endpoints
- `/auth/*` - Auth pages
- Any route containing `/login`, `/logout`, `/register`

## Icons

### Current Icons
- `/icon.svg` - Vector icon (exists)

### Required PNG Icons (to be generated)
- `/icon-192.png` - 192x192 standard icon
- `/icon-512.png` - 512x512 standard icon
- `/icon-maskable-192.png` - 192x192 maskable icon (Android adaptive)
- `/icon-maskable-512.png` - 512x512 maskable icon (Android adaptive)

### Generating Icons
```bash
# Install PWA Asset Generator
npm install -g pwa-asset-generator

# Generate all icon sizes from SVG
npx pwa-asset-generator public/icon.svg ./public --icon-only --path-override /
```

See `public/ICONS_README.md` for detailed icon generation instructions.

## Environment Detection

The app uses `src/lib/pwa/environment.ts` to detect:
- **Capacitor**: Running in native iOS/Android app
- **PWA**: Installed as standalone web app
- **Web**: Running in browser
- **Development**: Local development mode

### Service Worker Behavior
- **Development**: Disabled (faster development, avoid caching issues)
- **Capacitor**: Disabled (native app handles offline capabilities)
- **Production Web**: Enabled (provides PWA features)

## Meta Tags

The following PWA meta tags are configured in `src/app/layout.tsx`:

```typescript
export const viewport: Viewport = {
  width: 'device-width',
  initialScale: 1,
  maximumScale: 1,
  userScalable: false,
  themeColor: '#0f172a', // Dark blue theme
}

export const metadata: Metadata = {
  manifest: '/manifest.json',
  appleWebApp: {
    capable: true,
    statusBarStyle: 'black-translucent',
    title: 'Operate',
  },
  applicationName: 'Operate | CoachOS',
}
```

## Offline Features

### Offline Page
- Displays connection status
- Shows number of cached pages
- Provides retry button
- Auto-reloads when connection restored

### Cached Data
Users can access:
- Previously loaded pages
- Cached API responses
- Static assets (images, fonts, CSS, JS)
- Dashboard data (if previously visited)

### Sync Queue
The app includes an offline sync queue (`src/lib/offline/sync-queue.ts`) that:
- Queues actions when offline
- Automatically syncs when connection restored
- Handles conflict resolution

## Installation

### Web Browser
Users can install the PWA via:
- Browser's "Install App" button
- Custom install prompt component (`src/components/pwa/InstallPrompt.tsx`)

### Mobile Devices
- **iOS**: Add to Home Screen from Safari
- **Android**: Install app prompt appears automatically

## Testing

### Test PWA Locally
1. Build the production app: `pnpm build`
2. Start production server: `pnpm start`
3. Open in browser: `http://localhost:3000`
4. Open DevTools > Application > Service Workers
5. Check "Offline" to test offline mode

### Test Install
1. Build and serve production app
2. Open in browser (must be HTTPS or localhost)
3. Click install button in browser or use custom prompt
4. App should open in standalone window

### Test Cache
1. Navigate to different pages while online
2. Go offline (DevTools > Network > Offline)
3. Try navigating to cached pages
4. Should see cached content, not offline page

## Capacitor Integration

When building for native apps:
1. Service worker is automatically disabled via environment variable
2. Capacitor provides native offline capabilities
3. No conflict between PWA and native features

### Build for Native
```bash
# Set environment variable to disable PWA
NEXT_PUBLIC_IS_CAPACITOR=true pnpm build

# Sync with Capacitor
pnpm cap:sync
```

## Troubleshooting

### Service Worker Not Updating
```javascript
// Force update service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(registrations => {
    registrations.forEach(registration => registration.update());
  });
}
```

### Clear All Caches
```javascript
// Clear all PWA caches
if ('caches' in window) {
  caches.keys().then(names => {
    names.forEach(name => caches.delete(name));
  });
}
```

### Unregister Service Worker
```javascript
// Unregister all service workers
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(registrations => {
    registrations.forEach(registration => registration.unregister());
  });
}
```

## Best Practices

1. **Keep caches small**: Limit maxEntries to prevent storage issues
2. **Use appropriate strategies**: Cache First for static, Network First for dynamic
3. **Exclude sensitive data**: Never cache auth endpoints or user data
4. **Test offline thoroughly**: Ensure critical features work offline
5. **Update service worker**: Prompt users to reload when new version available
6. **Monitor cache size**: Clear old caches periodically

## Resources

- [Next PWA Documentation](https://github.com/shadowwalker/next-pwa)
- [Workbox Documentation](https://developer.chrome.com/docs/workbox/)
- [PWA Best Practices](https://web.dev/pwa-checklist/)
- [Web App Manifest](https://web.dev/add-manifest/)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)

## Maintenance

### Regular Tasks
- [ ] Monitor cache sizes
- [ ] Update manifest when app changes
- [ ] Generate new icons when branding changes
- [ ] Test PWA install flow quarterly
- [ ] Review and update caching strategies

### Version Updates
When updating next-pwa or Workbox:
1. Test thoroughly in development
2. Check service worker registration
3. Verify cache strategies still work
4. Test offline functionality
5. Verify no conflicts with Capacitor
