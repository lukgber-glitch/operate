# PWA Implementation Guide - Operate

## Overview

Operate is fully configured as a Progressive Web App (PWA) with offline support, installability, and push notifications.

## Features

### ✅ Implemented Features

1. **Web App Manifest** (`/public/manifest.json`)
   - App metadata and branding
   - Multiple icon sizes (72px - 512px)
   - Screenshots for app stores
   - Shortcuts to key features
   - Standalone display mode

2. **Service Worker** (Generated by `next-pwa`)
   - Automatic caching of static assets
   - Network-first strategy for API calls
   - Cache-first strategy for images
   - Offline fallback page
   - Background sync support

3. **Custom Service Worker** (`/public/sw-custom.js`)
   - Push notification handling
   - Background sync for offline actions
   - Periodic sync for data refresh
   - Enhanced cache management

4. **Install Prompt** (`/src/components/pwa/InstallPrompt.tsx`)
   - Smart install prompting
   - 30-day dismissal cooldown
   - Mobile-optimized UI
   - Feature highlights

5. **PWA Hook** (`/src/hooks/usePWA.ts`)
   - Installation management
   - Online/offline detection
   - Update checking
   - Notification permissions
   - Background sync queuing

6. **Service Worker Update** (`/src/components/service-worker-update.tsx`)
   - Automatic update detection
   - User-friendly update prompt
   - Seamless reload after update

7. **Offline Support**
   - Offline route (`/offline`)
   - Static offline fallback page
   - Auto-reload on reconnection

8. **PWA Utilities** (`/src/lib/pwa-utils.ts`)
   - Platform detection (iOS, Android)
   - Cache management
   - Storage quota monitoring
   - Capability checking

## Configuration

### Next.js PWA Config (`next.config.js`)

```javascript
const withPWA = require('@ducanh2912/next-pwa').default({
  dest: 'public',
  disable: process.env.NODE_ENV === 'development',
  register: true,
  skipWaiting: true,
  scope: '/',
  sw: 'sw.js',
  fallbacks: {
    document: '/offline',
  },
  workboxOptions: {
    // Caching strategies configured
    runtimeCaching: [...]
  },
})
```

### Caching Strategies

- **Google Fonts**: CacheFirst (1 year)
- **Static Fonts**: StaleWhileRevalidate (7 days)
- **Images**: StaleWhileRevalidate (24 hours)
- **JavaScript/CSS**: StaleWhileRevalidate (24 hours)
- **API Calls**: NetworkFirst (24 hours, 10s timeout)
- **Other Routes**: NetworkFirst (24 hours, 10s timeout)

## Usage

### Using the PWA Hook

```typescript
import { usePWA } from '@/hooks/usePWA'

function MyComponent() {
  const {
    isSupported,
    isInstalled,
    isOnline,
    canInstall,
    install,
    updateServiceWorker,
    showNotification,
    queueSync,
  } = usePWA()

  // Install the app
  const handleInstall = async () => {
    const success = await install()
    if (success) {
      console.log('App installed!')
    }
  }

  // Show a notification
  const handleNotify = async () => {
    await showNotification('Hello!', {
      body: 'This is a notification',
      icon: '/icons/icon-192x192.png',
    })
  }

  // Queue background sync
  const handleSync = () => {
    queueSync()
  }

  return (
    <div>
      {canInstall && <button onClick={handleInstall}>Install App</button>}
      {isOnline ? 'Online' : 'Offline'}
    </div>
  )
}
```

### Using PWA Utilities

```typescript
import {
  isStandalone,
  getCacheUsage,
  clearAllCaches,
  getPWACapabilities,
} from '@/lib/pwa-utils'

// Check if app is installed
if (isStandalone()) {
  console.log('Running as installed PWA')
}

// Get cache usage
const { usage, quota, percentage } = await getCacheUsage()
console.log(`Cache: ${percentage}% used`)

// Clear all caches (for debugging)
await clearAllCaches()

// Check PWA capabilities
const capabilities = getPWACapabilities()
console.log('PWA Capabilities:', capabilities)
```

## Testing

### Desktop Testing

1. **Chrome/Edge**
   - Open DevTools > Application > Service Workers
   - Check "Offline" to simulate offline mode
   - Application > Manifest to verify manifest
   - Look for install button in address bar

2. **Firefox**
   - Open DevTools > Application > Service Workers
   - Use Network throttling for offline testing

### Mobile Testing

1. **Android (Chrome)**
   - Visit the app
   - Tap the menu (3 dots)
   - Select "Install app" or "Add to Home Screen"
   - Test offline by enabling Airplane mode

2. **iOS (Safari)**
   - Visit the app
   - Tap the Share button
   - Select "Add to Home Screen"
   - Test offline by enabling Airplane mode

### Lighthouse Audit

Run a Lighthouse audit to check PWA score:

```bash
npm run build
npm run start
# Open Chrome DevTools > Lighthouse > Generate Report
```

Target scores:
- Performance: 90+
- Accessibility: 95+
- Best Practices: 95+
- SEO: 90+
- PWA: 100

## Deployment Checklist

### Pre-Deployment

- [ ] Icons generated (72, 96, 128, 144, 152, 192, 384, 512px)
- [ ] Screenshots captured (desktop and mobile)
- [ ] Manifest.json configured
- [ ] Service worker tested in production build
- [ ] Offline functionality verified
- [ ] Install prompt tested
- [ ] Notification permissions tested

### Post-Deployment

- [ ] Run Lighthouse audit
- [ ] Test on real devices (iOS and Android)
- [ ] Verify offline mode works
- [ ] Check install prompt appears
- [ ] Test update mechanism
- [ ] Verify HTTPS is working
- [ ] Check manifest.json is accessible

## Icon Requirements

The app needs icons in the following sizes:

- `icon-72x72.png` - Android small
- `icon-96x96.png` - Android medium
- `icon-128x128.png` - Android standard
- `icon-144x144.png` - iOS small
- `icon-152x152.png` - iOS standard
- `icon-192x192.png` - Android large (required)
- `icon-384x384.png` - Android extra large
- `icon-512x512.png` - Android splash screen (required)

**Note**: Icons should be placed in `/public/icons/` directory.

### Generating Icons

You can use tools like:
- [PWA Asset Generator](https://github.com/elegantapp/pwa-asset-generator)
- [RealFaviconGenerator](https://realfavicongenerator.net/)
- [PWA Builder](https://www.pwabuilder.com/)

```bash
# Using pwa-asset-generator
npx pwa-asset-generator logo.svg public/icons \
  --icon-only \
  --favicon \
  --padding "calc(50vh - 30%) calc(50vw - 30%)"
```

## Push Notifications

### Setup

1. Generate VAPID keys for push notifications:

```bash
npx web-push generate-vapid-keys
```

2. Add keys to environment variables:

```env
NEXT_PUBLIC_VAPID_PUBLIC_KEY=your_public_key
VAPID_PRIVATE_KEY=your_private_key
```

3. Subscribe to push notifications:

```typescript
const { showNotification } = usePWA()

// Request permission
await showNotification('Welcome!', {
  body: 'Thanks for enabling notifications',
})
```

## Background Sync

Background sync allows the app to defer actions until the user has connectivity.

```typescript
// Queue an action for background sync
const { queueSync } = usePWA()

// When user performs an action offline
async function saveData(data: any) {
  try {
    await api.save(data)
  } catch (error) {
    // Save to IndexedDB
    await db.pendingActions.add(data)
    // Queue for background sync
    queueSync()
  }
}
```

## Troubleshooting

### Service Worker Not Updating

```typescript
// Force update
const { checkForUpdates } = usePWA()
await checkForUpdates()
```

### Clear Cache

```typescript
import { clearAllCaches } from '@/lib/pwa-utils'
await clearAllCaches()
// Reload the page
window.location.reload()
```

### Install Prompt Not Showing

- Check if already installed
- Verify HTTPS is enabled
- Ensure manifest.json is valid
- Check browser console for errors
- Verify user hasn't dismissed recently

### Offline Page Not Showing

- Check next.config.js fallbacks configuration
- Verify /offline route exists
- Test in production build (not dev mode)

## Browser Support

| Feature | Chrome | Edge | Safari | Firefox |
|---------|--------|------|--------|---------|
| Service Worker | ✅ | ✅ | ✅ | ✅ |
| Install Prompt | ✅ | ✅ | ❌* | ❌ |
| Push Notifications | ✅ | ✅ | ✅ | ✅ |
| Background Sync | ✅ | ✅ | ❌ | ❌ |
| Periodic Sync | ✅ | ✅ | ❌ | ❌ |

*iOS Safari supports Add to Home Screen but not the install prompt API

## Production URLs

- **App**: https://operate.guru
- **Manifest**: https://operate.guru/manifest.json
- **Service Worker**: https://operate.guru/sw.js
- **Offline Page**: https://operate.guru/offline

## Resources

- [PWA Documentation](https://web.dev/progressive-web-apps/)
- [next-pwa Documentation](https://github.com/DuCanhGH/next-pwa)
- [Workbox Documentation](https://developer.chrome.com/docs/workbox/)
- [Web App Manifest](https://developer.mozilla.org/en-US/docs/Web/Manifest)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)

## Support

For issues or questions:
1. Check the browser console for errors
2. Review the Lighthouse PWA audit
3. Test in production mode (PWA disabled in development)
4. Verify HTTPS is working
5. Check service worker registration status
