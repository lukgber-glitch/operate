import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { QuickBooksAuthService } from './quickbooks-auth.service';
import { QuickBooksController } from './quickbooks.controller';
import { DatabaseModule } from '../database/database.module';
import quickbooksConfig from './quickbooks.config';

/**
 * QuickBooks Online Integration Module
 * Provides OAuth2-based integration with QuickBooks Online API
 *
 * Features:
 * - OAuth2 with PKCE authorization flow
 * - AES-256-GCM encrypted token storage
 * - Automatic token refresh mechanism
 * - Comprehensive audit logging
 * - Connection status management
 * - Multi-organization support
 *
 * Security:
 * - PKCE (Proof Key for Code Exchange) for enhanced OAuth security
 * - State parameter validation for CSRF protection
 * - Encrypted token storage in database
 * - Token refresh before expiry
 * - Secure token revocation on disconnect
 *
 * Environment Variables Required:
 * - QUICKBOOKS_CLIENT_ID: QuickBooks app client ID
 * - QUICKBOOKS_CLIENT_SECRET: QuickBooks app client secret
 * - QUICKBOOKS_REDIRECT_URI: OAuth callback URL
 * - QUICKBOOKS_ENVIRONMENT: 'sandbox' or 'production'
 * - QUICKBOOKS_ENCRYPTION_KEY: Master key for token encryption (min 32 chars)
 *
 * Optional Environment Variables:
 * - QUICKBOOKS_MINOR_VERSION: QuickBooks API minor version (default: 65)
 * - QUICKBOOKS_WEBHOOK_TOKEN: Webhook verifier token for webhooks
 */
@Module({
  imports: [
    ConfigModule.forFeature(quickbooksConfig),
    DatabaseModule,
  ],
  controllers: [QuickBooksController],
  providers: [QuickBooksAuthService],
  exports: [QuickBooksAuthService],
})
export class QuickBooksModule {}
