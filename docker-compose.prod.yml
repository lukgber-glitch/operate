version: '3.8'

# Production overrides for docker-compose.yml
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up

services:
  # API Production Configuration
  api:
    build:
      target: runner
      args:
        BUILD_DATE: ${BUILD_DATE}
        VCS_REF: ${VCS_REF}
        VERSION: ${VERSION}
    environment:
      NODE_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-warn}
    restart: always
    deploy:
      replicas: ${API_REPLICAS:-2}
      resources:
        limits:
          cpus: '${API_CPU_LIMIT:-1.0}'
          memory: ${API_MEMORY_LIMIT:-1G}
        reservations:
          cpus: '${API_CPU_RESERVATION:-0.5}'
          memory: ${API_MEMORY_RESERVATION:-512M}
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    healthcheck:
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Web Production Configuration
  web:
    build:
      target: runner
      args:
        BUILD_DATE: ${BUILD_DATE}
        VCS_REF: ${VCS_REF}
        VERSION: ${VERSION}
    environment:
      NODE_ENV: production
    restart: always
    deploy:
      replicas: ${WEB_REPLICAS:-2}
      resources:
        limits:
          cpus: '${WEB_CPU_LIMIT:-1.0}'
          memory: ${WEB_MEMORY_LIMIT:-1G}
        reservations:
          cpus: '${WEB_CPU_RESERVATION:-0.5}'
          memory: ${WEB_MEMORY_RESERVATION:-512M}
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    healthcheck:
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Workers Production Configuration
  workers:
    build:
      target: runner
      args:
        BUILD_DATE: ${BUILD_DATE}
        VCS_REF: ${VCS_REF}
        VERSION: ${VERSION}
    environment:
      NODE_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-warn}
    restart: always
    deploy:
      replicas: ${WORKERS_REPLICAS:-2}
      resources:
        limits:
          cpus: '${WORKERS_CPU_LIMIT:-1.0}'
          memory: ${WORKERS_MEMORY_LIMIT:-1G}
        reservations:
          cpus: '${WORKERS_CPU_RESERVATION:-0.5}'
          memory: ${WORKERS_MEMORY_RESERVATION:-512M}
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    healthcheck:
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Database Production Configuration
  postgres:
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-operate_prod}
    deploy:
      resources:
        limits:
          cpus: '${POSTGRES_CPU_LIMIT:-2.0}'
          memory: ${POSTGRES_MEMORY_LIMIT:-2G}
        reservations:
          cpus: '${POSTGRES_CPU_RESERVATION:-1.0}'
          memory: ${POSTGRES_MEMORY_RESERVATION:-1G}
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Redis Production Configuration
  redis:
    restart: always
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-}
    deploy:
      resources:
        limits:
          cpus: '${REDIS_CPU_LIMIT:-1.0}'
          memory: ${REDIS_MEMORY_LIMIT:-512M}
        reservations:
          cpus: '${REDIS_CPU_RESERVATION:-0.5}'
          memory: ${REDIS_MEMORY_RESERVATION:-256M}
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Disable dev tools in production
  pgadmin:
    profiles:
      - disabled

  redis-commander:
    profiles:
      - disabled
